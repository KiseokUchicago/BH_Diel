---
title: "peptide_level_visualization"
author: "KiseokUchicago"
date: "2021-02-22"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=11, fig.height=9,
                      error=TRUE, echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE)
```

### Peptide level visualization

```{r}
# libraries
library(dplyr)
library(tidyr)
library(stringr)
library(ggplot2)
library(formattable)
```

### 1. Quality check: Number of uniq peptides (sequence) per sample

```{r}
# read in combined table of 24 samples (Replicate B)
df_pep <- read.table("Replicate_ABC50_combined.tsv",sep='\t',header = T)

# count unique peptide per sample
df_uni <- df_pep %>% group_by(SampleID) %>% summarize(uniq_pep = length(unique(Base.Peptide.Sequence)))
df_uni1 <- df_uni %>% separate(SampleID, sep='_', into= c('Depth','Time','Replicate'),remove = F) %>% select(-Time, -Replicate)
df_uni2 <- df_uni1 %>% arrange(desc(Depth))

# get the order right from SRF -> DCL -> BDCL
ord <- df_uni2$SampleID 
df_uni2$SampleID <- factor(df_uni2$SampleID, levels = ord)
df_uni2$Depth <- factor(df_uni2$Depth, levels = c('SRF','DCL','BDCL'))

# Making barplot
theme_set(theme_bw())
cols <- c('SRF'='#fc8d62','DCL'='#66c2a5','BDCL'='#8da0cb')
uniq1 <- ggplot(df_uni2, aes(x=SampleID, fill=Depth, y=uniq_pep)) +  ## I put fill=value which was wrong
  geom_bar(stat="identity") +
  scale_fill_manual(values=cols) +
  ylab("Number of unique peptide sequence \n") +
  xlab("\n SampleID") +
  ggtitle("Number of unique peptide sequences per sample")+
  ## adjust positions
  theme(plot.title = element_text(size = 20,hjust = 0.5, family="serif")) + 
  theme(axis.title.x = element_text(size = 15,hjust = 0.5, family="serif")) + 
  theme(axis.title.y = element_text(size = 15,hjust = 0.5, family="serif")) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5, vjust=0.3,size=13, family="serif"))+
  theme(axis.text.y = element_text(size=10))+
  theme(panel.grid.major = element_blank()) +
  theme(panel.grid.minor = element_blank())

uniq2 <- uniq1 + geom_text(aes(x=df_uni$SampleID, y=df_uni$uniq_pep, label=df_uni$uniq_pep),
            size = 3, hjust = 0.5, position = position_stack(vjust = +1.05), family="serif")
uniq2

```

sample DCL_T8 doesn't seem to have good quality MS data. 


### 2. Number of accumulative uniq peptides (sequence): Does it saturate?

```{r}
# read in combined table of 24 samples (Replicate B)
df_pep <- read.table("Replicate_ABC50_combined.tsv",sep='\t',header = T)

# get unique peptides per sample
dt <- df_pep %>% select(SampleID, Base.Peptide.Sequence) %>% unique()
# change SampleID into number
dt1 <- dt %>% select(SampleID) %>% unique() %>% arrange(SampleID) %>%  arrange()
dt2 <- tibble::rownames_to_column(dt1,"depth")
# merge dt and dt2
dt_depth <- left_join(dt,dt2,by=c('SampleID'='SampleID'))
dim(dt_depth)

# get cumulative number of unique peptides (https://stackoverflow.com/questions/15698399/cumulative-count-of-unique-values-in-r)
require(data.table)
dt_depth <- as.data.table(dt_depth)
setkey(dt_depth, "depth")
dt_depth[, Base.Peptide.Sequence := as.numeric(factor(Base.Peptide.Sequence, levels = unique(Base.Peptide.Sequence)))]
setkey(dt_depth, "depth", "Base.Peptide.Sequence")
dt.out <- dt_depth[J(unique(depth)), mult="last"]
dt.out[, Base.Peptide.Sequence := cummax(Base.Peptide.Sequence)]

# getting ready to make plot
df.out <- tibble::rowid_to_column(dt.out) 
df.out2 <- df.out %>% select(rowid, Base.Peptide.Sequence) %>% rename(value=Base.Peptide.Sequence)
# Making line plot
theme_set(theme_bw())

p1 <- ggplot(df.out2,aes(x = rowid,y = value)) + geom_line(col="magenta") + geom_point(color='maroon') +
  ylab("Number of cumulative unique peptide sequence \n") +
  xlab("\n Number of cumulative samples") +
  # ylim(c(0,2200)) +
  ggtitle("Number of cumulative unique peptide sequences \n")+
  ## adjust positions
  theme(plot.title = element_text(size = 20,hjust = 0.5, family="serif")) + 
  theme(axis.title.x = element_text(size = 15,hjust = 0.5, family="serif")) + 
  theme(axis.title.y = element_text(size = 15,hjust = 0.5, family="serif")) + 
  theme(axis.text.x = element_text(hjust = 0.5, vjust=0.3,size=13, family="serif"))+
  theme(axis.text.y = element_text(size=10))
  # theme(panel.grid.major = element_blank())
  # theme(panel.grid.minor = element_blank())

p1


```
It seems to saturate as more samples are added.


### 3. Which Peptide_ids are present in all(almost) time points?
Make a histogram of x-axis being the # of time points present, y-axis being the number of Peptide_ids \
We need 3 histogram for (1) Surface, (2) DCL, and (3) BDCL

```{r}
# read in combined table of 24 samples (Replicate B)
df_pep <- read.table("Replicate_ABC50_combined.tsv",sep='\t',header = T)

# (1) Surface
colnames(df_pep)
df_srf <- df_pep %>% filter(Depth == 'SRF') %>% select(Peptide_id, SampleID, Time, Depth) %>% unique() %>% arrange(Peptide_id)
# How many time points did it appear
(df_srf2 <- df_srf %>% group_by(Peptide_id) %>% summarize(Timepoints = n_distinct(Time)) %>% ungroup())
# Check if Pep_1 appeared in 8 time points
df_srf %>% filter(Peptide_id=="Pep_1004") # true 8 times
# Histogram
theme_set(theme_bw())
ggplot(df_srf2, aes(Timepoints)) + geom_bar() +
  ylab("Number of peptides \n") +
  xlab("\n Cumulative number of timepoints peptide are present") +
  scale_x_continuous(breaks=seq(1,8,1))+
  ggtitle("Distribution of number of timepoints each Peptide_id appears (Surface) \n")+
  ## adjust positions
  theme(plot.title = element_text(size = 20,hjust = 0.5, family="serif")) + 
  theme(axis.title.x = element_text(size = 15,hjust = 0.5, family="serif")) + 
  theme(axis.title.y = element_text(size = 15,hjust = 0.5, family="serif")) + 
  theme(axis.text.x = element_text(hjust = 0.5, vjust=0.3,size=13, family="serif"))+
  theme(axis.text.y = element_text(size=10))
  # theme(panel.grid.major = element_blank())
  # theme(panel.grid.minor = element_blank())

# Let's try to plot all of them at once
df_all <- df_pep %>% select(Peptide_id, SampleID, Time, Depth) %>% unique() %>% arrange(Peptide_id)
# How many time points did it appear
(df_all2 <- df_all %>% group_by(Peptide_id, Depth) %>% summarize(Timepoints = n_distinct(Time)) %>% ungroup())
df_all2$Depth <- factor(df_all2$Depth, levels = c('SRF','DCL','BDCL'))

# Histogram
ggplot(df_all2, aes(Timepoints)) + geom_bar(aes(fill=Depth), position='dodge') +
  scale_fill_manual(values=cols) +
  ylab("Number of peptides \n") +
  xlab("\n Cumulative number of timepoints peptide are present") +
  scale_x_continuous(breaks=seq(1,8,1))+
  ggtitle("Distribution of number of timepoints each Peptide_id appears \n")+
  ## adjust positions
  theme(plot.title = element_text(size = 20,hjust = 0.5, family="serif")) + 
  theme(axis.title.x = element_text(size = 15,hjust = 0.5, family="serif")) + 
  theme(axis.title.y = element_text(size = 15,hjust = 0.5, family="serif")) + 
  theme(axis.text.x = element_text(hjust = 0.5, vjust=0.3,size=13, family="serif"))+
  theme(axis.text.y = element_text(size=10))
  # theme(panel.grid.major = element_blank())
  # theme(panel.grid.minor = element_blank())


```

Why does DCL have so less?

### 4. Plotting time series fluctuation for the peptides
First retrieve the log intensity value for all peptides (average over the same spec_id)

```{r}
# (1) Get list of peptides that are present in 7 or 8 timepoints
df_all2_filt <- df_all2 %>% filter(Timepoints > 6) %>% unique() 

# (2) Let's average the intensity for each unique peptide
df_int <- df_pep %>% select(Peptide_id, Spec_id, log2.18O.16O.Ratio, SampleID, Time, Depth, Replicate) %>% unique() %>% arrange(Peptide_id)
head(df_int)
df_ave <- df_int %>% group_by(SampleID, Time, Depth, Replicate, Peptide_id) %>% summarize(Mean_log2_intensity=mean(log2.18O.16O.Ratio)) %>% ungroup()
head(df_ave)

# (3) import time metadata and merge
(df_time <- read.table('data/Time_metadata.txt', header=T, sep='\t'))
# left_join with average data
df_ave2 <- df_ave %>% left_join(df_time, by=c('Time'='timepoint'))
head(df_ave2)
# only use peptides that appear 7 or 8 times
df_ave2 %>% select(SampleID,Peptide_id) %>% unique() %>% dim() # 15452 peptides before
df_filt78 <- inner_join(df_ave2, df_all2_filt, by=c('Peptide_id'='Peptide_id','Depth'='Depth'))

# inspecting if the inner join was successful
head(df_filt78)
colnames(df_ave2)
colnames(df_time)
colnames(df_filt78)

df_filt78 %>% select(SampleID,Peptide_id) %>% unique() %>% dim() # 7304 peptides for peptides in 7 or 8 timepoints
df_filt78$Depth <- factor(df_filt78$Depth, levels = c('SRF','DCL','BDCL'))

# get only 8 ones
df_filt8 <- df_filt78 %>% filter(Timepoints > 7)
df_filt8 %>% select(SampleID,Peptide_id) %>% unique() %>% dim() # 4112 peptides for peptides in all 8 timepoints
df_filt8$Depth <- factor(df_filt8$Depth, levels = c('SRF','DCL','BDCL'))

# get only 7 ones
df_filt7 <- df_filt78 %>% filter(Timepoints == 7)
df_filt7 %>% select(SampleID,Peptide_id) %>% unique() %>% dim() # 3192 peptides for peptides in 7 timepoints
df_filt8$Depth <- factor(df_filt8$Depth, levels = c('SRF','DCL','BDCL'))

```

Plot for peptides present in 8 timepoints
```{r}

# (4) Plot the scatter plot 
theme_set(theme_bw())

ggplot(df_filt8, aes(x=elapsed_hours,y=Mean_log2_intensity, color=Depth, group=Peptide_id)) +
  geom_point(size=2, shape=21) +
  geom_line()+
  scale_color_manual(values=cols) +
  ylab("Mean log2 intensity (log2(18O/16O)) \n") +
  xlab("\n Elapsed hours after 12:45pm June 26 2019") +
  scale_x_continuous(breaks=seq(0,26,1))+
  ggtitle("Time series intensity of peptide_id \n")+
  ## adjust positions
  theme(plot.title = element_text(size = 20,hjust = 0.5, family="serif")) + 
  theme(axis.title.x = element_text(size = 15,hjust = 0.5, family="serif")) + 
  theme(axis.title.y = element_text(size = 15,hjust = 0.5, family="serif")) + 
  theme(axis.text.x = element_text(hjust = 0.5, vjust=0.3,size=13, family="serif"))+
  theme(axis.text.y = element_text(size=10)) 
  # theme(panel.grid.major = element_blank()) +
  # theme(panel.grid.minor = element_blank())
```


4.1. Surface(SRF)

```{r}
# color code
# 1. Surface(orange): #fc8d62
# 2. DCL(green): #66c2a5
# 3. BDCL(blue): #8da0cb
color_vec <- c('#fc8d62','#66c2a5','#8da0cb')
depth_vec <- c('SRF','DCL','BDCL')

time_series_1depth <- function(df_filt78, depth){
  theme_set(theme_bw())
  # filter depth
  df_filt78_s <- df_filt78 %>% filter(Depth == depth_vec[depth])
  ggplot(df_filt78_s, aes(x=elapsed_hours,y=Mean_log2_intensity, group=Peptide_id)) +
    geom_point(size=2, shape=21, color=color_vec[depth]) +
    geom_line(color= color_vec[depth])+
    ylab("Mean log2 intensity (log2(18O/16O)) \n") +
    xlab("\n Elapsed hours after 12:45pm June 26 2019") +
    scale_x_continuous(breaks=seq(0,26,1))+
    ggtitle(paste0("Time series intensity of peptide_id"," (",depth_vec[depth],")","\n"))+
    ## adjust positions
    theme(plot.title = element_text(size = 20,hjust = 0.5, family="serif")) + 
    theme(axis.title.x = element_text(size = 15,hjust = 0.5, family="serif")) + 
    theme(axis.title.y = element_text(size = 15,hjust = 0.5, family="serif")) + 
    theme(axis.text.x = element_text(hjust = 0.5, vjust=0.3,size=13, family="serif"))+
    theme(axis.text.y = element_text(size=10)) 
    # theme(panel.grid.major = element_blank()) +
    # theme(panel.grid.minor = element_blank())
}

# when we use all 7, 8 appearance cases
time_series_1depth(df_filt78,1)

# when we use only 8 appearance cases
time_series_1depth(df_filt8,1)

# when we use only 7 appearance cases
time_series_1depth(df_filt7,1)

```

4.2. Deep Chlorophyll layer (DCL)

```{r}
# when we use all 7, 8 appearance cases
time_series_1depth(df_filt78,2)

# when we use only 8 appearance cases
time_series_1depth(df_filt8,2)

# when we use only 7 appearance cases
time_series_1depth(df_filt7,2)

```

4.3. Below Deep Chlorophyll layer (BDCL)

```{r}
# when we use all 7, 8 appearance cases
time_series_1depth(df_filt78,3)

# when we use only 8 appearance cases
time_series_1depth(df_filt8,3)

# when we use only 7 appearance cases
time_series_1depth(df_filt7,3)

```

